# ðŸ”§ DB-GPT æ•°æ®åº“Schemaæ°¸ä¹…è§£å†³æ–¹æ¡ˆ

## ðŸ“‹ é—®é¢˜æ ¹æœ¬åŽŸå› 

é€šè¿‡æ·±å…¥åˆ†æžæ—¥å¿—å’Œç³»ç»Ÿæœºåˆ¶ï¼Œç¡®è®¤äº†**è¡¨ç»“æž„æ€»ä¸ºç©º**çš„æ ¹æœ¬åŽŸå› ï¼š

### ðŸŽ¯ æ ¸å¿ƒé—®é¢˜
1. **DB-GPTä¸ç›´æŽ¥ä»ŽTOMLé…ç½®æ–‡ä»¶åŠ è½½æ•°æ®æº**
   - TOMLæ–‡ä»¶ä¸­çš„`[[datasources]]`é…ç½®ä¸ä¼šè‡ªåŠ¨ç”Ÿæ•ˆ
   - ç³»ç»Ÿä½¿ç”¨æ•°æ®åº“æŒä¹…åŒ–ç®¡ç†æ•°æ®æº

2. **æ•°æ®æºéœ€è¦æ‰‹åŠ¨æ³¨å†Œ**
   - é€šè¿‡APIæˆ–Webç•Œé¢æ³¨å†Œ
   - æˆ–ç›´æŽ¥å†™å…¥ç³»ç»Ÿå…ƒæ•°æ®æ•°æ®åº“

3. **ç³»ç»Ÿæ—¥å¿—ç¡®è®¤**
   ```
   æ•°æ®åº“å: orange
   è¡¨ç»“æž„å®šä¹‰: []  â† è¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨
   ```

## ðŸ› ï¸ æ°¸ä¹…è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šè‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæŽ¨èï¼‰

1. **ä½¿ç”¨è‡ªåŠ¨æ³¨å†Œè„šæœ¬**
   ```bash
   # è¿è¡Œè‡ªåŠ¨æ³¨å†Œè„šæœ¬
   ./init-datasource.sh
   ```

2. **è„šæœ¬åŠŸèƒ½**
   - ç­‰å¾…DB-GPTæœåŠ¡å¯åŠ¨
   - è‡ªåŠ¨æ³¨å†Œorangeæ•°æ®æº
   - éªŒè¯æ³¨å†Œç»“æžœ
   - æä¾›å¤‡ç”¨æ–¹æ¡ˆ

### æ–¹æ¡ˆäºŒï¼šæ‰‹åŠ¨Webç•Œé¢æ³¨å†Œ

1. **è®¿é—®Webç•Œé¢**
   ```
   http://localhost:5670
   ```

2. **æ·»åŠ æ•°æ®æº**
   - ç‚¹å‡»"æ•°æ®æºç®¡ç†"
   - æ·»åŠ æ–°æ•°æ®æº
   - é…ç½®è¿žæŽ¥ä¿¡æ¯ï¼š
     ```
     åç§°: orange
     ç±»åž‹: MySQL
     ä¸»æœº: 10.10.19.1
     ç«¯å£: 9030
     æ•°æ®åº“: orange
     ç”¨æˆ·å: ai_user1
     å¯†ç : Weshare@2025
     ```

### æ–¹æ¡ˆä¸‰ï¼šAPIç›´æŽ¥æ³¨å†Œ

```bash
# ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 30

# æ³¨å†Œæ•°æ®æº
curl -X POST "http://localhost:5670/api/v1/datasources" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "orange",
    "type": "mysql",
    "host": "10.10.19.1",
    "port": 9030,
    "database": "orange",
    "username": "ai_user1",
    "password": "Weshare@2025",
    "description": "é€¾æœŸçŽ‡åˆ†æžæ•°æ®åº“(Apache Doris)",
    "sync_schema": true
  }'
```

### æ–¹æ¡ˆå››ï¼šæ•°æ®åº“ç›´æŽ¥å†™å…¥ï¼ˆæœ€å¯é ï¼‰

```bash
# è¿›å…¥å®¹å™¨
docker-compose exec webserver bash

# è¿è¡ŒPythonè„šæœ¬
python3 -c "
import sqlite3
import json
import os

db_path = '/app/pilot/data/default_sqlite.db'
if os.path.exists(db_path):
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    # åˆ›å»ºæ•°æ®æºè¡¨ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS datasource (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT UNIQUE NOT NULL,
            type TEXT NOT NULL,
            config TEXT,
            description TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # æ’å…¥æ•°æ®æºé…ç½®
    datasource_config = {
        'host': '10.10.19.1',
        'port': 9030,
        'database': 'orange',
        'username': 'ai_user1',
        'password': 'Weshare@2025',
        'charset': 'utf8mb4',
        'sync_schema': True
    }
    
    cursor.execute('''
        INSERT OR REPLACE INTO datasource 
        (name, type, config, description) 
        VALUES (?, ?, ?, ?)
    ''', (
        'orange', 
        'mysql', 
        json.dumps(datasource_config),
        'é€¾æœŸçŽ‡åˆ†æžæ•°æ®åº“(Apache Doris)'
    ))
    
    conn.commit()
    conn.close()
    print('âœ… æ•°æ®æºé…ç½®å·²å†™å…¥æ•°æ®åº“')
else:
    print('âŒ æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨')
"

# é‡å¯æœåŠ¡ä»¥åŠ è½½é…ç½®
exit
docker-compose restart webserver
```

## ðŸ”„ è‡ªåŠ¨åŒ–å¯åŠ¨æµç¨‹

### åˆ›å»ºå¯åŠ¨è„šæœ¬

```bash
# åˆ›å»º start-with-datasource.sh
cat > start-with-datasource.sh << 'EOF'
#!/bin/bash

echo "ðŸš€ å¯åŠ¨DB-GPTå¹¶è‡ªåŠ¨é…ç½®æ•°æ®æº..."

# å¯åŠ¨æœåŠ¡
docker-compose up -d

# ç­‰å¾…æœåŠ¡å¯åŠ¨
echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 60

# è‡ªåŠ¨æ³¨å†Œæ•°æ®æº
echo "ðŸ“Š è‡ªåŠ¨æ³¨å†Œæ•°æ®æº..."
./init-datasource.sh

echo "âœ… å¯åŠ¨å®Œæˆï¼è®¿é—® http://localhost:5670"
EOF

chmod +x start-with-datasource.sh
```

### ä½¿ç”¨æ–¹æ³•

```bash
# æ¯æ¬¡å¯åŠ¨æ—¶è¿è¡Œ
./start-with-datasource.sh
```

## ðŸŽ¯ éªŒè¯æ–¹æ³•

### 1. æ£€æŸ¥æ•°æ®æºæ˜¯å¦æ³¨å†ŒæˆåŠŸ

```bash
# æ–¹æ³•1ï¼šé€šè¿‡APIæ£€æŸ¥
curl -s "http://localhost:5670/api/v1/datasources" | grep orange

# æ–¹æ³•2ï¼šé€šè¿‡æ•°æ®åº“æ£€æŸ¥
docker-compose exec webserver python3 -c "
import sqlite3
conn = sqlite3.connect('/app/pilot/data/default_sqlite.db')
cursor = conn.cursor()
cursor.execute('SELECT * FROM datasource WHERE name=\"orange\"')
result = cursor.fetchone()
if result:
    print('âœ… æ•°æ®æºå·²æ³¨å†Œ:', result[1])
else:
    print('âŒ æ•°æ®æºæœªæ³¨å†Œ')
conn.close()
"
```

### 2. æµ‹è¯•è¡¨ç»“æž„åŠ è½½

```bash
# å‘é€æµ‹è¯•æŸ¥è¯¢
curl -X POST "http://localhost:5670/api/v1/chat/completions" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "chat_with_db_execute",
    "messages": [{"role": "user", "content": "æ•°æ®åº“æœ‰å¤šå°‘ä¸ªè¡¨ï¼Ÿ"}],
    "chat_param": "orange",
    "temperature": 0.6
  }' | grep -q "è¡¨ç»“æž„ä¿¡æ¯ä¸è¶³" && echo "âŒ è¡¨ç»“æž„ä»ä¸ºç©º" || echo "âœ… è¡¨ç»“æž„åŠ è½½æˆåŠŸ"
```

## ðŸ“ æ³¨æ„äº‹é¡¹

1. **æ¯æ¬¡é‡å¯åŽéƒ½éœ€è¦é‡æ–°æ³¨å†Œæ•°æ®æº**
   - å»ºè®®ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬
   - æˆ–å°†æ³¨å†Œæ­¥éª¤åŠ å…¥å¯åŠ¨æµç¨‹

2. **Apache Doriså…¼å®¹æ€§**
   - ä½¿ç”¨MySQLé©±åŠ¨è¿žæŽ¥
   - ç¦ç”¨æŸäº›MySQLç‰¹æœ‰åŠŸèƒ½

3. **æ•°æ®åº“æ–‡ä»¶ä½ç½®**
   - å…ƒæ•°æ®å­˜å‚¨åœ¨ï¼š`/app/pilot/data/default_sqlite.db`
   - ç¡®ä¿æ•°æ®å·æ­£ç¡®æŒ‚è½½

## ðŸŽ‰ æ€»ç»“

é€šè¿‡ä»¥ä¸Šä»»ä¸€æ–¹æ¡ˆï¼Œéƒ½èƒ½ç¡®ä¿æ¯æ¬¡Dockeré‡å¯åŽæ­£ç¡®è¯»å–æ•°æ®åº“schemaã€‚æŽ¨èä½¿ç”¨**è‡ªåŠ¨åŒ–è„šæœ¬æ–¹æ¡ˆ**ï¼Œä¸€æ¬¡é…ç½®ï¼Œæ°¸ä¹…æœ‰æ•ˆã€‚ 